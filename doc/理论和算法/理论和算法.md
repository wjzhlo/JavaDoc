## 理论和算法

### ACID

https://blog.csdn.net/shuaihj/article/details/14163713

`ACID 是指在可靠的数据库系统中，一个事务所应该具有的四个特性`

| 简写 | 全拼        | 名称   | 描述                                                         |
| ---- | ----------- | ------ | ------------------------------------------------------------ |
| A    | Atomicity   | 原子性 | 原子性指一个事务是不可再分割的工作单位，事务中的操作要么都发生，要么都不发生 |
| C    | Consistency | 一致性 | 一致性指事务开始之前和事务结束后，都不会破坏数据库中关系数据的完整性以及业务逻辑上的一致性<br />。数据库中的关系完整性由数据库保证，但业务一致性需要开发者保证。<br />如： 转账，数据库必定会保证两个账户之和与事务之前的账户之和相同 |
| I    | Isolation   | 隔离性 | 隔离性指多个事务并发执行时，事务之间是隔离的，不会互相影响   |
| D    | Druable     | 持久性 | 持久性指事务完成以后，该事务对数据库所做的更改便保存在数据库之中不会被回滚 |



### CAP 理论

#### 概念

`CAP 指在一个分布式系统中，不可能同时满足一致性、可用性、分区容错性这三个基本需求，最多只能满足其中两项。`

对于一个分布式系统，分区容错性是最基本的要求，因为分布式系统的组件必然会部署到不同的机器上，这就会出现网络问题导致的异常。因此一般分布式系统只能在`一致性`和`可用性`之间权衡

| 名称                             | 描述                                                 |
| -------------------------------- | ---------------------------------------------------- |
| Consistency (一致性)             | 所有的节点在同一时间具有相同的数据                   |
| Availability (可用性)            | 保证每个请求不管成功或者失败都有响应                 |
| Partition tolerance (分区容错性) | 系统中任意信息的丢失或失败，都不会影响系统的继续运作 |



#### 组合：

- **AC：**单点
- **AP：**强调系统的高可用性，即允许数据不是强一致的，而是通过其他方式保证数据的最终一致性，如发送一个友好的错误提示响应，而不是无响应
  
- 大多数项目默认使用 AP 模式更合理，因为当服务器故障时可以发挥友好提示给请求方，提高用户体验
  
- **CP：**强调必须保证一致性，若服务出现故障，就会拒接请求，但这时候就违背了系统可用性

  - 其实 AP 模式和 CP 模式的最大区别在于 AP 模式会保留失效的节点，并返回友好提示。而 CP 模式会马上剔除相应的节点

    由此可以考虑，`当项目内的服务都做了集群，使用 CP 模式可以保证请求不会被转发到断开的节点去，以此保证了整体的效率提高`



#### 常用注册中心的比较

https://www.pianshen.com/article/28671393800/

https://blog.csdn.net/fly910905/article/details/100023415

|                  | Nacos                      | Eureka      | Consul        | Zookeeper |
| ---------------- | -------------------------- | ----------- | ------------- | --------- |
| CAP              | CP 或 AP                   | AP          | CP            | CP        |
| 健康检查         | TCP/HTTP/MYSQL/Client Beat | Client Beat | TCP/HTTP/gRPC | TCP       |
| 负载均衡策略     | 权重                       | Ribbon      | Fabio         | 无        |
| 雪崩保护         | 有                         | 有          | 无            | 无        |
| 自动注销实例     | 支持                       | 支持        | 支持          | 支持      |
| 访问协议         | HTTP/DNS                   | HTTP        | HTTP/DNS      | TCP       |
| 监听支持         | 支持                       | 支持        | 支持          | 支持      |
| SpringCloud 集成 | 支持                       | 支持        | 支持          | 支持      |
| Dubbo 集成       | 支持                       | 不支持      | 支持          | 支持      |
| K8S 集成         | 支持                       | 不支持      | 支持          | 不支持    |



### Base 理论

#### 概念

`Base 理论是由 CAP 定理演化而来的，核心思想是即使无法做到强一致性，但每个业务根据自身的特点，采用适当的方式来使系统达到最终一致性。基本概念为：基本可用、柔性事务以及最终一致性。Base 理论是对 CAP 中一致性和可用性权衡的结果。`

|                                   | 描述                                                         |
| --------------------------------- | ------------------------------------------------------------ |
| 基本可用 (Basically Available)    | 基本可用指分布式系统在出现故障的时候，允许损失部分可用性，保证核心可用，但不等价于不可用 |
| 柔性事务 (Soft-state)             | 柔性事务指状态可以有一段时间不同步(响应延长、服务降级等)     |
| 最终一致性 (Eventual Consistency) | 最终一致性指所有的数据副本经过一定时间后，最终能够达到一致的状态，不需要实时保证系统数据的强一致性 |



#### 和 ACID 对比

Base 理论是反 ACID 的，完全不同于 ACID 模型，Base 理论牺牲了强一致性，来获取基本可用性和柔性事务，并要求达到最终一致性

`即 Base 理论面向的是大型高可用可扩展的分布式系统，通过牺牲强一致性来获得可用性`



### 数据一致性理论

- **强一致性**
  - 即只要更新操作完成后，任何后续进程的访问都会返回最新的更新过的值，即 CAP 中的 CP
- **弱一致性**
  - 系统在写入成功后，不保证立刻读到最新写入的值，也无法保证读到最新值的时间
- **最终一致性**
  - 最终一致性即保证所有的数据副本在经过一段时间同步后，最终能够达到数据一致的状态



### ZAB 协议

#### 概念

`ZAB 协议是 Zookeeper 专门设计的一种支持崩溃恢复、主从同步的原子广播协议，以此实现集群中分布式数据的一致性`



#### 模式

##### 崩溃恢复模式

`恢复模式主要是在服务框架启动时，或是 leader 节点宕机时发生`

当整个服务框架在启动过程中，或是当 leader 节点出现网络中断、崩溃退出等异常情况，zab 协议就会进入恢复模式并选举产生新的 leader 服务器。当选举产生了新的 leader 服务器，且集群中有过半的机器与该 leader 服务器完成了状态同步后，zab 协议就会退出恢复模式，进入消息广播模式



##### 消息广播模式

`当集群中有过半的 follower 节点完成了和 leader 的状态同步，整个服务框架就进入消息广播模式。`

消息广播模式主要分为读操作和写操作：

- 读操作
  - 由于 zab 保证了分布式数据的一致性，因此每个 follower 节点都保存有最新的数据副本，无论客户端连接的是哪一个节点都可以直接从节点中读取到最新的数据
- 写操作
  - 写操作只能由 leader 节点发起。如果客户端连接的是一个 follower 节点，这个写请求也会被 follower 节点转发到 leader 节点，再由 leader 节点发起写请求



##### 写操作流程

zab 协议的写操作是通过类似二段提交的方式实现保证数据一致性的

- leader 从客户端收到一个写请求 / leader 从 follower 接收到一个转发过来的写请求
- leader 生成一个新的事务，并为这个事务生成一个唯一的 ZXID
- leader 将这个事务提议(propose)给所有的 follower 节点
- follower 节点将收到的事务请求加入到历史队列中，并发送 ack(确认) 给 leader
- 当 leader 收到大多数(半数以上)的 follower 的 ack 消息后，leader 会发送 commit 请求给这些 follower
- 当 follower 收到 leader 发来的 commit 请求后，会从历史队列中将事务请求 commit

<img src="理论和算法.assets/image-20210309091749243.png" style="zoom:80%;" />



### Paxos 算法

https://www.zhihu.com/question/19787937

Paxos 是用于解决分布式系统强一致性的问题

内部有 Proposer 提议者，Acceptor 接受者，Learners 记录员



### CAS 算法

#### 概念

`CAS 全称(Compare And Swap 比较和交换)，是一种无锁算法，可以在不使用锁的情况下实现多线程间变量的同步。可用于乐观锁的实现。`

实则内部是借助于一个 cpu 指令完成的，是一个原子操作，可以保证线程安全性。当更新成功时会返回最新的存储内容，若更新失败则会返回 false



#### 运行机制

**CAS 有三个操作数**

- 内存地址V
- 旧的预期值A
- 要修改的新值B



**流程为：**

- 先获取旧值A=0
- 修改新值B=1，但并没有写入内存地址V中
- 重新读取V中存放的值，与存储的旧值A对比，若相同则将新值B写入内存V中，若不相同则放弃已做的修改，重新执行原来的操作



#### ABA 问题

ABA 问题即一个数据从 A 改成了 B，又从 B 改回了 A，这时候其实内容变化了，但是 CAS 在检查时无法发现值变化

举个例子：

- 小明验证账户上有100元后，取出50元。——账上有50元
- 小强不会验证小明账户的余额，直接汇款50元。——账上有100元
- 诈骗分子验证账户有100元后，取出50元。——账上有50元
- 最终结果：小强没有告诉小明自己汇钱，小明也没收到短信，那么小明就一直以为只有自己取款操作，最后损失了50元



##### 解决方案：

通过版本号对比，jdk1.5 中提供了 AtomicStampedReference 解决



#### 优缺点

- 优点
  - CAS 是一种无锁算法，解决了并发情况下的原子性问题，且效率高于 sychronized
- 缺点
  - 由于 CAS 是不断循环判断的，若一直失败，则会一直占用 cpu 资源
  - 只能保证一个共享变量的原子性。即多个变量操作时，当前只能用互斥锁的方式处理
